# Maintainer: Massimiliano Torromeo <massimiliano.torromeo@gmail.com>
# Contributor: Iwan Timmer <irtimmer@gmail.com>

pkgname=pcp
pkgver=5.2.3
pkgrel=1
pkgdesc="System performance analysis toolkit"
arch=('x86_64')
url="https://pcp.io"
license=('LGPL')
depends=('python' 'avahi' 'procps-ng' 'which')
makedepends=('libmicrohttpd' 'cairo' 'qt5-svg')
optdepends=('libmicrohttpd: support for pmwebd'
            'cairo: support for pmwebd'
            'qt5-svg: support for PCP-GUI and pmchart'
            'perl-xml-tokeparser: support for sar2pcp'
            'perl-date-parse: support for sar2pcp')
source=("https://github.com/performancecopilot/pcp/archive/$pkgver/$pkgname-$pkgver.tar.gz"
        "ncurses-config.patch::https://github.com/performancecopilot/pcp/commit/c57d71813b342e340eb5d399400f10ba35040da5.patch"
        "sysuser.conf"
        "tmpfile.conf")
sha256sums=('ef80e3c1e3271ee06baf8989ae89e1a3b1b9d9f5de05eb43e4716c51a975a04b'
            '956feca9be1ac44173cf6ef8a9f6f0d85b6d584b45397d5ed11b4d3d6ba1aac5'
            '3e21ef7925296f73c91fe85c8dba341ce00366163845dd8993e2813b0ad5e4a4'
            '0166ffea180527de5a48a8e8f145cc80860b93e8f44bc5f96836c3d1cb4b01a2')

prepare() {
  cd "$pkgname-$pkgver"
  patch -p1 -i "$srcdir"/ncurses-config.patch
}

build() {
  cd "$pkgname-$pkgver"
  ./configure \
    --prefix=/usr \
    --sbindir=/usr/bin \
    --libexecdir=/usr/lib \
    --sysconfdir=/etc \
    --localstatedir=/var \
    --with-rundir=/run/pcp \
    --without-dstat-symlink
  make
}

package() {
  cd "$pkgname-$pkgver"
  make DIST_ROOT="$pkgdir" PCP_USER=root PCP_GROUP=root install

  install -D -m644 "$srcdir"/sysuser.conf "$pkgdir"/usr/lib/sysusers.d/pcp.conf
  install -D -m644 "$srcdir"/tmpfile.conf "$pkgdir"/usr/lib/tmpfiles.d/pcp.conf

  rm -vrf "$pkgdir"/var/lib/pcp/testsuite "$pkgdir"/run "$pkgdir"/var/tmp
}
