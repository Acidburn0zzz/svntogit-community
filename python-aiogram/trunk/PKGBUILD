# Maintainer: Felix Yan <felixonmars@archlinux.org>
# Contributor: Evgeniy Filimonov <evgfilim1@gmail.com>

pkgname=python-aiogram
pkgver=2.14
pkgrel=1
pkgdesc="A pretty simple and fully asynchronous library for Telegram Bot API written with asyncio and aiohttp"
arch=('any')
url="https://github.com/aiogram/aiogram"
license=('MIT')
depends=('python-aiohttp' 'python-babel')
makedepends=('python-setuptools')
checkdepends=('python-aiohttp-socks' 'python-aioredis' 'python-aresponses' 'python-pytest'
              'python-pytest-lazy-fixture' 'pifpaf' 'redis')
optdepends=('python-uvloop: fast, drop-in replacement of the built-in asyncio event loop'
            'python-ujson: ultra fast JSON encoder and decoder written in pure C'
            'python-rapidjson: extremely fast C++ JSON parser and serialization library'
            'python-emoji: emojize and demojize support'
            'python-aioredis: Redis storage support'
            'python-aiohttp-socks: SOCKS4(a) and SOCKS5 proxy support'
#            'python-rethinkdb: RethinkDB storage support'  # No such package yet
)
source=("$url/archive/v$pkgver/$pkgname-$pkgver.tar.gz"
        https://github.com/aiogram/aiogram/commit/2b4e3ad5c661956a8d7edaae72164f6b189e2fec.patch
        https://github.com/aiogram/aiogram/commit/a26c6428a3a1c06665f0fa5e9a8853b4ad8add30.patch)
sha512sums=('0ecb80bc7cedc4a46f1c30ec3df2e6b48031476826884cdb5321cc2549d908fe33ccea544b7166c3c25bddc90a50b1fbec8641f2fbc8c781b9d96dcc1a311dcf'
            '7139d0fab37802f1256cc27f5a7781f07d2263712c852b7f7bd4986f0c7ac0513823dd0de1ab73e235a4e0f61271ec5f70285952779b49acb4fb2c9eab1576c6'
            '9faa6de7029c74a7c8c78f2db52ac9dcfcbee52e30e3f48db041718a3dc08460d3392525cdcf763ad0cb739c703f39ed9c82677c47e10df61607bbd5a14191c2')

prepare() {
  cd aiogram-$pkgver
  patch -p1 -i ../2b4e3ad5c661956a8d7edaae72164f6b189e2fec.patch
  patch -p1 -i ../a26c6428a3a1c06665f0fa5e9a8853b4ad8add30.patch
  sed -e '/import certifi/d' \
      -e 's|certifi.where()|"/etc/ssl/certs/ca-certificates.crt"|' \
      -i aiogram/bot/base.py
}

build() {
  cd aiogram-$pkgver
  python setup.py build
}

check() {
  cd aiogram-$pkgver
  pifpaf run redis -- bash -c 'python -m pytest --redis $PIFPAF_REDIS_URL'
}

package() {
  cd aiogram-$pkgver
  python setup.py install --root="$pkgdir" --optimize=1 --skip-build

  install -Dm644 LICENSE -t "$pkgdir"/usr/share/licenses/$pkgname/
  install -Dm644 README.md -t "$pkgdir"/usr/share/doc/$pkgname/
}
