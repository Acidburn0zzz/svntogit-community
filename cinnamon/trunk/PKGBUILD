# Maintainer: Eli Schwartz <eschwartz@archlinux.org>
# Contributor: Alexandre Filgueira <alexfilgueira@cinnarch.com>
# Contributor: M0Rf30
# Contributor: unifiedlinux
# Contributor: CReimer

pkgname=cinnamon
pkgver=4.2.4
pkgrel=3
pkgdesc="Linux desktop which provides advanced innovative features and a traditional user experience"
arch=('x86_64')
url="https://github.com/linuxmint/${pkgname}"
license=('GPL2')
depends=('accountsservice' 'caribou' 'cinnamon-control-center' 'cinnamon-menus' 'cinnamon-screensaver'
         'cinnamon-session' 'cinnamon-settings-daemon' 'cjs' 'gnome-backgrounds'
         'gnome-themes-extra' 'gstreamer' 'libgnomekbd' 'libkeybinder3' 'librsvg' 'muffin'
         'network-manager-applet' 'nemo' 'polkit-gnome' 'python-cairo' 'python-dbus'
         'python-gobject' 'python-pam' 'python-pexpect' 'python-pillow' 'python-pyinotify'
         'python-tinycss' 'xapps')
optdepends=('blueberry: Bluetooth support'
            'cinnamon-translations: i18n'
            'gnome-panel: fallback mode'
            'metacity: fallback mode'
            'system-config-printer: printer settings')
makedepends=('intltool' 'gtk-doc' 'gobject-introspection')
options=('!emptydirs')
source=("${pkgname}-${pkgver}.tar.gz::${url}/archive/${pkgver}.tar.gz"
        "${url}/commit/6e7ea0640ddb97d54febfbb76ac0e5cd0c0349d4.patch"
        "${url}/commit/058e3a1e7dd26eca4bacb37b7c20c1e9d430de6a.patch"
        "${url}/pull/8964/commits/568064ce7ec056118a69275232c0e7e4ba93b056.patch"
        "0001-cinnamon-settings-don-t-rely-on-the-presence-of-cinn.patch"
        "set_wheel.patch"
        "default-theme.patch")
sha512sums=('6ba5a760253ece582c2b6cc037d92b9d51a1ae397312d852c4e08c5ab6e64e1f01f88f58e87bb5eaffc9e26c2a3ebcddbf0292449d5b95404deed59ad48edf38'
            '4339ceebabdf087b31141f1b2edafb34b064ceb549ccdabcb101c02aa2a5d0f6e4cc4976d6f3d119c11f7662469d4e716cc23ab777dead398843398710e22821'
            '3b0adefccfcac1c3fd99efdbfd8768cd0940749c06e53ce25a23f43a9bc8ae80c695cf841b70450f58c544aae771446b70dd74d092540804986961545dc8a114'
            '68433d69b421212966c9086050a1776cd98adfd63e4dad21863a1db0cc30ded062f6f1536008c1ec266b03d207e23abb46bba958b73abf485a436322ecb13e77'
            '77c2229d350bb1445375d206af769f1dde9329ce3575e40e9c1d5fea3ec0f49c0a7ef36d78caf895d9224147947bd102bab924b5579dc8dc5f8d3269e0c76374'
            'fd7e117054996ed1c3dfd0f968c2bf98ca4fcee9a100221f8839a232147745ec0140e1f68eeffba58a3c44f66f26e05d433648a7a28858ec669524f7266ba04c'
            '3c460141b277df61c4546cc311fa5ecc7e7ea19a7d39a92d1d0214c37a91b4e163bc91823df7098bd2cf6fb430361cdb9839ab96abe53fe82f2a735e187de563')
b2sums=('92018afef197066765c9c3ea8e82528f77519aed60b463727b845a557ac6a8990cd509891123a63384ae5e95f39b77ff66ec1a85c42877dc7209d02a9c492a96'
        'cd51f0a3d1f9594f8bca62b58db0e8f1a5db760d86c4d2f6d30c077280a6c0c9e24b5d385ff2d2ebf196997b948bb1c5da7f4f343405a7dc9298c134af0846a0'
        '4af32c1cfcbaf70e29d57ebaa7c46e567435cc46e7f5817ab72e1c04de7b270d280ca3cd44bc38770c8953e8cc5dd8dc50fbc7cb19939418891ea77ad01fd1d3'
        'fbebc287959c684ad475c9e15f8c8664f31674e7720b119ddb8cc1e8f85b04ff74e34e016c273baa5e3efb95c6be7f50e3a0632aac2245af79ab4a7996c9eef4'
        '1d873efa0d17e358f834c4374f39bbf3f74340849f9c28a0950c0a064772083798aba3435e564acdf43a94665389917788e295073d4a65cc18600d71b7a9f008'
        '3becf1f40068fc629109e6e7d464c3c484296afacc9ab6328b2ccbb3c9735bcbfa9550f9f73b430ede178ae668e37c660ce322b5b4d1873526de3d3d41185160'
        '3a7515cc7b0ca1549289be62f6d5cbd79f4b076892194f4b6264555322d430a3d6474db9ec62439f3ba41d43d1017dc39a4c44add2e5e5c09f32012b772a7041')

prepare() {
    cd "${srcdir}"/${pkgname}-${pkgver}

    # backport fix for crash in cinnamon-settings' "Preferred Applications"
    # https://github.com/linuxmint/cinnamon/issues/8853
    patch -p1 -i ../6e7ea0640ddb97d54febfbb76ac0e5cd0c0349d4.patch
    # python 3.8 backport
    patch --no-backup-if-mismatch -p1 -i ../058e3a1e7dd26eca4bacb37b7c20c1e9d430de6a.patch
    # this gettext call never worked: https://bugs.archlinux.org/task/64543
    patch -p1 -i ../568064ce7ec056118a69275232c0e7e4ba93b056.patch

    # Check for the cc-panel module path, not for the irrelevant binary
    # https://github.com/linuxmint/cinnamon/pull/7382
    patch -p1 -i ../0001-cinnamon-settings-don-t-rely-on-the-presence-of-cinn.patch

    # Use wheel group instread of sudo (taken from Fedora)
    patch -Np1 -i ../set_wheel.patch

    # Set default theme to 'cinnamon'
    patch -Np1 -i ../default-theme.patch

    # Replace MintInstall with GNOME Software
    sed -i 's/mintinstall.desktop/org.gnome.Software.desktop/' data/org.cinnamon.gschema.xml.in

    # Add polkit agent to required components
    sed -i 's/RequiredComponents=\(.*\)$/RequiredComponents=\1polkit-gnome-authentication-agent-1;/' \
        files/usr/share/cinnamon-session/sessions/cinnamon*.session

    # https://github.com/linuxmint/cinnamon/issues/3575#issuecomment-374887122
    # Cinnamon has no upstream backgrounds, use GNOME backgrounds instead
    sed -i 's|/usr/share/cinnamon-background-properties|/usr/share/gnome-background-properties|' \
        files/usr/share/cinnamon/cinnamon-settings/modules/cs_backgrounds.py

    NOCONFIGURE=1 ./autogen.sh
}

build() {
    cd "${srcdir}"/${pkgname}-${pkgver}

    ./configure --prefix=/usr \
                --sysconfdir=/etc \
                --libexecdir=/usr/lib/cinnamon \
                --localstatedir=/var \
                --disable-static \
                --disable-gtk-doc \
                --disable-schemas-compile \
                --enable-compile-warnings=yes

    # https://bugzilla.gnome.org/show_bug.cgi?id=656231
    sed -i -e 's/ -shared / -Wl,-O1,--as-needed\0/g' libtool

    make
}

package() {
    cd "${srcdir}"/${pkgname}-${pkgver}

    make DESTDIR="${pkgdir}" install
}
