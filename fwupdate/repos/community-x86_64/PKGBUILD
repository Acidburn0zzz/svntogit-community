# Maintainer: Bruno Pagani <archange@archlinux.org>
# Contributor: Mirco Tischler <mt-ml at gmx dot de>

pkgname=fwupdate
pkgver=11
pkgrel=1
pkgdesc="Tools for using the ESRT and UpdateCapsule() to apply firmware updates"
arch=('x86_64')
url="https://github.com/rhinstaller/fwupdate"
license=('GPL2')
depends=('efivar' 'libsmbios' 'bash')
makedepends=('pesign' 'gnu-efi-libs')
source=("${url}/releases/download/${pkgver}/${pkgname}-${pkgver}.tar.bz2"
        'esp-as-boot.hook'
        'esp-as-boot-efi.hook')
sha256sums=('d350eae66215c90fdc70f46ea734dedbfe6006ec21b7e764114b7d9e283e4abe'
            '20f696fbcba5a5de644eb06b71954adfde6dcc4f619075392977a248f96a59b6'
            '3ad20522b5e3118312a31cab7ab915c2427ecaf72a83759ffb7229bccfb65259')
install=fwupdate.install

_efidir=arch

build() {
    cd ${pkgname}-${pkgver}
    make EFIDIR="${_efidir}" GNUEFIDIR=/usr/lib
}

package() {
    cd ${pkgname}-${pkgver}

    make LIBDIR=/usr/lib EFIDIR="${_efidir}" DESTDIR="${pkgdir}" libexecdir=/usr/lib/ install

    # Remove cleanup script, it requires hardcoding of ESP path
    rm -r "${pkgdir}"/usr/lib/systemd/
    rm "${pkgdir}"/usr/lib/fwupdate/cleanup

    # Do not install anything under /boot. Copy files to /usr/lib/fwupdate for manual or hook installation.
    install -d "${pkgdir}"/usr/{lib,share/doc}/${pkgname}
    mv "${pkgdir}"/boot/efi/EFI "${pkgdir}"/usr/lib/${pkgname}/EFI
    rm -rf "${pkgdir}"/boot
    rm -rf "${pkgdir}"/usr/src
    rm -rf "${pkgdir}"/usr/lib/debug
    cd ..
    install -Dm644 esp-as-boot.hook -t "${pkgdir}"/usr/share/doc/${pkgname}/
    install -Dm644 esp-as-boot-efi.hook -t "${pkgdir}"/usr/share/doc/${pkgname}/
}
