# Maintainer: Sven-Hendrik Haase <svenstaro@gmail.com>

# NOTE: Gitlab isn't always compatible with modern Ruby versions. In that case, check the
# commit log for an old fix on how to tell it to use older versions of Ruby. I'm afraid we'll
# need this again at some point in the future.
pkgname=gitlab-gitaly
pkgver=13.0.5
pkgrel=1
pkgdesc="Speed up Git access using caching"
arch=('x86_64')
url="https://gitlab.com/gitlab-org/gitaly"
license=('MIT')
depends=(glibc ruby libxml2 libxslt libssh2)
options=(!buildflags)
makedepends=(go ruby-bundler cmake)
backup=("etc/gitlab-gitaly/config.toml")
_tag=v${pkgver}
source=("https://gitlab.com/gitlab-org/gitaly/-/archive/${_tag}/gitaly-${_tag}.tar.gz"
        "ruby27.patch::https://gitlab.com/gitlab-org/gitaly/-/merge_requests/2227.patch"
        "configs.patch"
        "gitlab-gitaly.service")
sha512sums=('04c0e12cf01ba3917bfb1e44029b467eecda25603a34c6eb1dec92f0b23c6e9179f8085169faeb968c8974caebe4b1c73b14e12e4898c2beead98640b74de565'
            '76ed13110aab0bf5075eebd45c97e2c2499e0f035dfd51a9e20f95f968f8d4d3c2ad7b097b0590b7a70e6b61f783cc3aab5517b0bcf02acc7b02833c1a88ef0c'
            '28bfb8f290d6d6206b75e2f35d8fd15b298baa005b533648550f224c6bf4fd16eeda4e2b8ff3231873ef208172f391a553956684f81867451bc08b7ad18d581f'
            'e6c31cab200424af118ee9da4def0963a52727f33025fdbdb515c6c1337a9b32f4a377bd925fdd33ffe7b91371ce1d5d70847e07c2b73eac1e85d3f38f5e1261')

prepare() {
  cd gitaly-$_tag

  patch -p1 < ../configs.patch
  # At this point the config file should not contain any references to '/home/git'

  patch -p1 < ../ruby27.patch

  # https://github.com/bundler/bundler/issues/6882
  sed -e '/BUNDLED WITH/,+1d' -i ruby/Gemfile.lock
}

build() {
  cd gitaly-$_tag

  bundle config force_ruby_platform true # build from sources as some prebuilt gems are not available for newer ruby
  make BUILD_TAGS="tracer_static tracer_static_jaeger"
}

package() {
  cd gitaly-$_tag

  make PREFIX=/usr DESTDIR=${pkgdir} install
  mkdir -p ${pkgdir}/etc/gitlab-gitaly
  mkdir -p ${pkgdir}/usr/share/webapps/gitlab-gitaly
  cp -r ruby ${pkgdir}/usr/share/webapps/gitlab-gitaly/ruby

  install -Dm644 config.toml.example "${pkgdir}/etc/${pkgname}/config.toml"
  install -Dm644 "LICENSE" "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
  install -Dm0644 "${srcdir}/gitlab-gitaly.service" "${pkgdir}/usr/lib/systemd/system/gitlab-gitaly.service"
}

# vim:set ts=2 sw=2 et:
