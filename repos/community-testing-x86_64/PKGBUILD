# Maintainer: Felix Yan <felixonmars@archlinux.org>
# Contributor: Josip Ponjavic <josipponjavic at gmail dot com>
# Contributor: Xu Fasheng <fasheng.xu[AT]gmail.com>

pkgname=deepin-terminal
pkgver=5.2.2.20200601
_commit=4f83513d1bff94604d7e3c022c36ea34f9779e9d
pkgrel=1
pkgdesc='Default terminal emulation application for Deepin'
arch=('x86_64')
url="https://github.com/linuxdeepin/deepin-terminal-reborn"
license=('GPL3')
depends=('deepin-qt5integration')
makedepends=('chrpath' 'cmake' 'expac' 'lxqt-build-tools' 'qt5-tools')
optdepends=('zssh: for remote management support')
groups=('deepin-extra')
source=("$pkgname-$_commit.tar.gz::https://github.com/linuxdeepin/deepin-terminal-reborn/archive/$_commit.tar.gz")
sha512sums=('1b31ccda8f430ec480c2dae92b031fd76c715e862d89ecbc06485b90117ccc73825450a52816556852005de764664cbc9a8df09e02554cbf70c1325e26f4cd0c')

prepare() {
  mkdir -p build
  cd deepin-terminal-reborn-$_commit
  # Devendor qtermwidget - disabled due to the vendored copy has changes
  #rm -r terminalwidget
  #sed -i '/terminalwidget/d;/build_qtermwidget/d' deepin-terminal.pro
  #sed -i 's|terminalwidget/lib/qtermwidget.h|qtermwidget5/qtermwidget.h|' encodeplugin/encodelistmodel.cpp views/termwidget.h theme/themelistmodel.cpp

  # Much upstream weirdness
  sed -i '/<QHash>/i#include <QObject>\n#include <QMap>' 3rdparty/terminalwidget/lib/SessionManager.h
  #sed -i 's/QString("/QString::fromLatin1("/;s/message = "Session crashed.";/message = QString::fromLatin1("Session crashed.");/' 3rdparty/terminalwidget/lib/{Filter,Session}.cpp
  sed -i '/LXQtCompilerSettings/a remove_definitions(-DQT_NO_CAST_FROM_ASCII -DQT_NO_CAST_TO_ASCII)' 3rdparty/terminalwidget/CMakeLists.txt
  sed -i '/#include <QTextStream>/a #include <cwctype>' 3rdparty/terminalwidget/lib/TerminalCharacterDecoder.cpp
  sed -i '/#include <QPainter>/a #include <QPainterPath>' src/customcommand/customcommanddelegate.cpp src/remotemanage/serverconfigdelegate.cpp src/theme/themeitemdelegate.cpp
  sed -i 's|default-config.json|src/assets/other/default-config.json|' CMakeLists.txt
}

build(){
  cd build
  cmake -DDTKCORE_TOOL_DIR=/usr/lib/libdtk-$(expac %v dtkcore | cut -d - -f 1 | cut -d : -f 2)/DCore/bin ../deepin-terminal-reborn-$_commit
  make
}

package() {
  cd build
  make DESTDIR="$pkgdir" install

  rm -r "$pkgdir"/build
  chrpath --delete "$pkgdir"/usr/bin/deepin-terminal
}
