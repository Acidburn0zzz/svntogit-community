From 86bdab06c8598b3735c78104288431eecbd88d72 Mon Sep 17 00:00:00 2001
From: Erik de Castro Lopo <erikd@mega-nerd.com>
Date: Mon, 18 Apr 2016 11:31:07 +1000
Subject: [PATCH] yesod-form: Make it work with persistent 2.5

---
 yesod-form/Yesod/Form/Fields.hs | 44 ++++++++++++++++++++---------------------
 1 file changed, 21 insertions(+), 23 deletions(-)

diff --git a/yesod-form/Yesod/Form/Fields.hs b/yesod-form/Yesod/Form/Fields.hs
index 81daa7c..05051f8 100644
--- a/yesod-form/Yesod/Form/Fields.hs
+++ b/yesod-form/Yesod/Form/Fields.hs
@@ -73,7 +73,7 @@ import qualified Text.Email.Validate as Email
 import Data.Text.Encoding (encodeUtf8, decodeUtf8With)
 import Data.Text.Encoding.Error (lenientDecode)
 import Network.URI (parseURI)
-import Database.Persist.Sql (PersistField, PersistFieldSql (..))
+import Database.Persist.Sql (PersistField, PersistFieldSql (..), PersistQueryRead, BaseBackend)
 import Database.Persist (Entity (..), SqlType (SqlString))
 import Text.HTML.SanitizeXSS (sanitizeBalance)
 import Control.Monad (when, unless)
@@ -91,7 +91,7 @@ import qualified Data.ByteString.Lazy as L
 import Data.Text as T ( Text, append, concat, cons, head
                       , intercalate, isPrefixOf, null, unpack, pack, splitOn
                       )
-import qualified Data.Text as T (drop, dropWhile)  
+import qualified Data.Text as T (drop, dropWhile)
 import qualified Data.Text.Read
 
 import qualified Data.Map as Map
@@ -645,16 +645,16 @@ optionsEnum = optionsPairs $ map (\x -> (pack $ show x, x)) [minBound..maxBound]
 -- >         <$> areq (selectField countries) "Which country do you live in?" Nothing
 -- >         where
 -- >           countries = optionsPersist [] [Asc CountryName] countryName
-optionsPersist :: ( YesodPersist site, PersistEntity a
-                  , PersistQuery (PersistEntityBackend a)
-                  , PathPiece (Key a)
-                  , RenderMessage site msg
-                  , YesodPersistBackend site ~ PersistEntityBackend a
-                  )
-               => [Filter a]
-               -> [SelectOpt a]
-               -> (a -> msg)
-               -> HandlerT site IO (OptionList (Entity a))
+optionsPersist
+    :: (PersistEntityBackend t ~ BaseBackend (YesodPersistBackend site)
+       , YesodPersist site, PersistEntity t
+       , PersistQueryRead (YesodPersistBackend site)
+       , PathPiece (Key t), RenderMessage site message
+       )
+    => [Filter t]
+    -> [SelectOpt t]
+    -> (t -> message)
+    -> HandlerT site IO (OptionList (Entity t))
 optionsPersist filts ords toDisplay = fmap mkOptionList $ do
     mr <- getMessageRender
     pairs <- runDB $ selectList filts ords
@@ -669,17 +669,15 @@ optionsPersist filts ords toDisplay = fmap mkOptionList $ do
 --
 -- Since 1.3.2
 optionsPersistKey
-  :: (YesodPersist site
-     , PersistEntity a
-     , PersistQuery (PersistEntityBackend a)
-     , PathPiece (Key a)
-     , RenderMessage site msg
-     , YesodPersistBackend site ~ PersistEntityBackend a
-     )
-  => [Filter a]
-  -> [SelectOpt a]
-  -> (a -> msg)
-  -> HandlerT site IO (OptionList (Key a))
+    :: (PersistEntityBackend t ~ BaseBackend (YesodPersistBackend site)
+       , YesodPersist site, PersistEntity t
+       , PersistQueryRead (YesodPersistBackend site)
+       , PathPiece (Key t), RenderMessage site message
+       )
+    => [Filter t]
+    -> [SelectOpt t]
+    -> (t -> message)
+    -> HandlerT site IO (OptionList (Key t))
 
 optionsPersistKey filts ords toDisplay = fmap mkOptionList $ do
     mr <- getMessageRender
