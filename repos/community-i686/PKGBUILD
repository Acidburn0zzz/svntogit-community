# $Id$
# Maintainer: Sergej Pupykin <arch+pub@sergej.pp.ru>
# Maintainer: Jonas Heinrich <onny@project-insanity.org>
# Contributor: Jonas Heinrich <onny@project-insanity.org>

pkgname=libreoffice-online
pkgver=2.1.1
pkgrel=1
pkgdesc="HTML5-based/cloud-based version of the office suite"
arch=('x86_64' 'i686')
url="https://cgit.freedesktop.org/libreoffice/online/"
license=("MPL")
makedepends=("cppunit" "poco" "libreoffice-fresh-sdk" "jake" "npm" "chrpath" "python-polib")
depends=("libpng12" "poco" "pcre" "cpio" "libreoffice" "openssl-1.0")
backup=("etc/loolwsd/loolwsd.xml")
install="libreoffice-online.install"
source=("${pkgname}-${pkgver}.tar.gz::https://github.com/LibreOffice/online/archive/${pkgver}.tar.gz"
	"loolwsd.service"
	"build-fix.patch")
sha512sums=('fbb939631e9938800389e09842cf0bf079c0c2907f93ba13cc2e1c2dc4950f36a7206f2145c9f905c916820fed4fcd02b1b72765f0d299df804b67d82e3d045f'
            '71fd3aec864b1f084dafc602a7fadc91fed146b57dba8cacc7bc277a42f197616a6a43c07d13e2e74a604166cd691a81f5c7de447ddecb680919e3f6b451adb6'
            'c39fbba5d5f46e201b7db8dceb4af305e4210894aca7c2d7282af13ad1878f57065bbc7329ac69c52de10a7d5661f2697ea2156d9f275045a03737dc240ccbba')

prepare() {
  cd "${srcdir}/online-${pkgver}"
  patch -p1 <"$srcdir"/build-fix.patch
}

build() {
  cd "${srcdir}/online-${pkgver}"
  ./autogen.sh
  export PKG_CONFIG_PATH=/usr/lib/openssl-1.0/pkgconfig
  CPPFLAGS="-I/usr/include/openssl-1.0" \
  CFLAGS="-I/usr/include/openssl-1.0" \
  LDFLAGS="-L/usr/lib/openssl-1.0" \
      ./configure --enable-silent-rules \
	--with-lokit-path=/usr/include/libreoffice \
	--with-lo-path=/usr/lib/libreoffice \
	--prefix=/usr \
	--sysconfdir=/etc
  BUILDING_FROM_RPMBUILD=yes make
}

package() {
  cd "${srcdir}/online-${pkgver}"
  BUILDING_FROM_RPMBUILD=yes make DESTDIR=${pkgdir} install
  install -Dm644 "${srcdir}/loolwsd.service" "${pkgdir}/usr/lib/systemd/system/loolwsd.service"
  mkdir -p "${pkgdir}/var/lib/lool"
  mkdir -p "${pkgdir}/var/cache/loolwsd"
  mkdir -p "${pkgdir}/var/lib/lool/child-roots"
  chmod u+w "${pkgdir}/var/lib/lool/child-roots"
  sed -i 's|/usr/var/cache/loolwsd|/var/cache/loolwsd|g' ${pkgdir}/etc/loolwsd/loolwsd.xml
  mkdir -p "${pkgdir}/usr/share/loolwsd/loleaflet"
  cp -r "loleaflet/dist" "${pkgdir}/usr/share/loolwsd/loleaflet/"
  chrpath -d "$pkgdir/usr/bin/"{loolmount,loolforkit}
}
