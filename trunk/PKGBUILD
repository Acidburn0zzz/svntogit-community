# Maintainer: Bruno Pagani <archange@archlinux.org>

pkgname=tpm2-abrmd
pkgver=2.0.3
pkgrel=1
pkgdesc='Trusted Platform Module 2.0 Access Broker and Resource Management Daemon'
arch=('x86_64')
url='https://github.com/tpm2-software/tpm2-abrmd'
license=('BSD')
depends=('dbus' 'glib2' 'tpm2-tss')
checkdepends=('cmocka' 'ibm-sw-tpm2' 'net-tools')
source=("${url}/releases/download/${pkgver}/${pkgname}-${pkgver}.tar.gz"{,.asc})
sha256sums=('ff0ed283b0300cd784d6bf2b042e167020f8443602974e53b924e9fd98a4b515' 'SKIP')
validpgpkeys=('42007E876F248E04A3F2FE25AE4548D043DEC7C3') # Philip Tricca <philip.b.tricca@intel.com>

build() {
    cd ${pkgname}-${pkgver}
    ./configure --prefix=/usr \
                --sbindir=/usr/bin \
                --with-dbuspolicydir=/usr/share/dbus-1/system.d \
                --enable-unit \
                --enable-integration
    make
}

check() {
    cd ${pkgname}-${pkgver}
    dbus-run-session -- make check
}

package() {
    cd ${pkgname}-${pkgver}
    make DESTDIR="${pkgdir}" install
    rm -r "${pkgdir}"/usr/lib/systemd/system-preset
    install -Dm644 LICENSE -t "${pkgdir}"/usr/share/licenses/${pkgname}/
}
