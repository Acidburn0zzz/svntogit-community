# Maintainer: Felix Yan <felixonmars@archlinux.org>
# Contributor: Harry Jeffery <harry|@|exec64|.|co|.|uk>
# Contributor: Alex Jordan <alexander3223098@gmail.com>

pkgname=zerotier-one
pkgver=1.5.0
pkgrel=2
pkgdesc="Creates virtual Ethernet networks of almost unlimited size."
arch=('x86_64')
url="https://www.zerotier.com/index.html"
license=('GPL3')
depends=('gcc-libs' 'libnatpmp' 'miniupnpc')
source=("$pkgname-$pkgver.tar.gz::https://github.com/zerotier/ZeroTierOne/archive/$pkgver.tar.gz"
        "zerotier-one-1.4.6-gcc10-fix.patch::https://github.com/zerotier/ZeroTierOne/commit/cce4fa719d447c55d93458b25fa92717a2d61a60.patch"
        'https://github.com/zerotier/ZeroTierOne/commit/2c75be0d64772c17c8e39fafd0e8c9daff935485.patch'
        'https://github.com/zerotier/ZeroTierOne/commit/bcb3fc7fc00fbb21c339dbd5dc1c79cd910f3969.patch'
        'https://github.com/zerotier/ZeroTierOne/commit/70f37962cfea04272c49371ee1b68e212e086b67.patch'
        'https://github.com/zerotier/ZeroTierOne/commit/ed9b09e98019db5818a2dc310139ff3289412c50.patch')
sha512sums=('9c579016153872afd51410d2648670537309c67b523fb180e9a17530d3e812a039b0ffa96f3035f7c8a69e19e1eb3f8315693206219cec1494118f7accc2fa31'
            '3929bf88a1df1001ac36f4b6dec0d70be45039dfd9418b16b64249ed5566c9997f17ff6d563ea00b509f5e6d8b1b8de95d20cd7b7c972d201e4fa78844395bd8'
            'b63c34e2d9ec286abc99452f6947fcdffc5cbc8f11e554108bd4ad8de0ab4b4f0c287ee448b715b2d683e98ca5bcfca7a83f447480588e97a7b492417d006cec'
            '41e5a472df4b4d77db34270c0949769fe34456c9570505da0d57c2e7381dd798292189fde29a1810eaf0d34f737658bcd2e1e3f915ca82fc83dba25675635235'
            'e2dfdf9c012de91d1fead54ebca5bc7055d25e5e7f23176574cf9a8aa163a4730bbd49f46bb69c20cbde3f956bfce6b5f3266d3aa2706f46eaf4593dd0a194e9'
            'e05aa27635aa200c255d91aded762a0d7c1b8b4980bf706ee2a16fe985517a63da391542d5695a1bdc9c00f0941e0430b65c688de9a00c463752df2c4083e8e6')

prepare() {
  cd ZeroTierOne-$pkgver
  sed -i 's/sbin/bin/' make-linux.mk debian/zerotier-one.service

  # Fix compilation with GCC 10 (https://github.com/zerotier/ZeroTierOne/pull/1232)
  patch -Np1 -i "$srcdir/zerotier-one-1.4.6-gcc10-fix.patch"
  patch -Np1 -i ../2c75be0d64772c17c8e39fafd0e8c9daff935485.patch
  patch -Np1 -i ../bcb3fc7fc00fbb21c339dbd5dc1c79cd910f3969.patch
  patch -Np1 -i ../70f37962cfea04272c49371ee1b68e212e086b67.patch
  patch -Np1 -i ../ed9b09e98019db5818a2dc310139ff3289412c50.patch
}

build() {
  cd ZeroTierOne-$pkgver
  make
}

check() {
  cd ZeroTierOne-$pkgver
  make selftest
  ./zerotier-selftest
}

package() {
  cd ZeroTierOne-$pkgver
  make DESTDIR="$pkgdir" install
  install -Dm644 debian/zerotier-one.service "$pkgdir"/usr/lib/systemd/system/zerotier-one.service
}
