# Maintainer: Christian Rebischke <chris.rebischke@archlinux.org>
pkgname=ct
pkgver=0.9.1
pkgrel=1
pkgdesc='config transpiler for Flatcar Container Linux'
arch=('x86_64' 'aarch64')
url='https://github.com/flatcar-linux/container-linux-config-transpiler'
license=('Apache')
depends=('kubectl')
makedepends=('git' 'go')
source=("${pkgname}-${pkgver}.tar.gz::https://github.com/flatcar-linux/container-linux-config-transpiler/archive/refs/tags/v${pkgver}.tar.gz")
sha512sums=('9975f7624b790e15764272cfed3ba314e5e4467a9300c2448137c907ae602e3290e98402493bd50c42f193b299dfa4d3ed67d2b897fd5d752aeb3fd319af83c9')
b2sums=('ac1d89cc3651961651eb73848fb3bcbc66f30401ecebb0f5b15661fb9c256ead2e6362bf268e201c33e95995284ef75f395e87138e44caff785f3d59bb399d23')

build() {
  cd "${pkgname}-${pkgver}"
  export CGO_LDFLAGS="$LDFLAGS"
  export CGO_CFLAGS="$CFLAGS"
  export CGO_CPPFLAGS="$CPPFLAGS"
  export CGO_CXXFLAGS="$CXXFLAGS"
  export GOFLAGS='-buildmode=pie -trimpath -modcacherw -mod=readonly'
  go build -ldflags="-w -s -linkmode=external" ./internal/
}

check() {
  cd "${pkgname}-${pkgver}"
  go test ./...
}

package() {
  cd "${pkgname}-${pkgver}"
  install -Dm755 ct "${pkgdir}/usr/bin/ct"
}
