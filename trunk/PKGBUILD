# Maintainer: Sergej Pupykin <pupykin.s+arch@gmail.com>
# Maintainer: David Runge <dvzrv@archlinux.org>

pkgname=nextcloud
pkgver=21.0.0
pkgrel=2
pkgdesc="A cloud server to store your files centrally on a hardware controlled by you"
arch=('any')
url="https://nextcloud.com"
license=('AGPL3')
depends=('php7>=7.4.0' 'php7<7.5.0' 'php7-gd')
optdepends=(
  'ffmpeg: for preview generation'
  'mariadb: to use a local MariaDB server'
  'memcached: to use a local memcached server'
  'php7-apcu: for caching with APCU'
  'php7-apache: to use the Apache web server'
  'php7-fpm: to run in fastCGI process manager'
  'php7-imagick: for preview generation'
  'php7-imap: for external user authentication'
  'php7-intl: to increase language translation performance and fix sorting'
  'php7-ldap: for LDAP authentication'
  'php7-memcached: for caching with memcached'
  'php7-pgsql: to use the PostgreSQL database backend'
  'php7-redis: for caching with redis'
  'php7-sqlite: to use the SQLite database backend'
  'postgresql: to use a local PostgreSQL server'
  'redis: to use a local Redis server'
  'smbclient: for SMB/CIFS integration'
  'sudo: for occ command'
  'libreoffice: for preview generation'
  'uwsgi: run as application container'
)
backup=(
  "etc/webapps/${pkgname}/config.php"
  "etc/uwsgi/${pkgname}.ini"
)
# there are no elf files, no need to strip anything
options=(!strip)
install="${pkgname}.install"
source=(
  "https://download.nextcloud.com/server/releases/nextcloud-${pkgver}.tar.bz2"{,.asc}
  'apache.example.conf'
  "${pkgname}.hook"
  "${pkgname}.occ.sh"
  "${pkgname}.sysusers"
  "${pkgname}.tmpfiles"
  "${pkgname}.uwsgi"
)
sha512sums=('a1ae3400f0fb5997e54b0cee821c50d13e4ba0e27c9d11731c8b5233cba564666121a58aed848ccd2593a9783e27db1ed98ff559588a76a1acaeaf083ef4404a'
            'SKIP'
            '6f9f284d78d414a3bb7c159a812b105e31e8cd2393afee44465701e6f18169709f6d492d790e403e1e66f308c51b6b6496d29ddce29e4fac2c73a3c84a10c7fe'
            '76754f2facddaca388a9cfe302850e3265bfeee55c5942d830a1bfd9a3ce303eb6e585ec93e372c9aabfe50f75f06912a88426d80e1b7808c73a18ffde52643f'
            '8a0cd48b39566ab94b5bf5989c630c2c7e4abe89cad89e5f8e85d3355b5e059f4a1ff1b4600a3c974f3b0bed33fa14831182517fd4b9fb5983c52396d3ab3588'
            '1d06f339c43d57e5f5406c2698b815241fd9e39039a9e55f777face510c9a5ddae5ccd4e051393e8f16f391301a6aa03fff2462837a2d3441d969ea7195e7d84'
            '4f951e7cad06940d983035c3dc51531bbbcbc0c74296af63f2fab1705b413f340ff67300506377fade0ed7ddecee8552b3da028711751c120f1fad4b1c33e8d5'
            'a3ebcabcdb8c2d2653f44a248abd213bc4dbb317766b82c8f3e93b31e72ace350d7e8037bd4e22a632ab33f739e1941467b0e9d2cf7d0a7433227b4169030051')
b2sums=('7c583c150f6b315830191329310993582439e7aef57f306b93681d654b8fa7d4d5dafee082befd493aafd2bf6efd940d52ca0ca05b8e42b79a1599ff3e809550'
        'SKIP'
        'a7e1aa1d8cb2b0ff7832bb7d6d857987733253317c0f3727e744502aeaa3b2008351b47ecc24e348fe7b252cefaffe2418797523ee288dfd55e128917e8fbe2c'
        '0776acc402b4f6a913ab904bf9721fdb927f37410f599afb6b77411243e6d5db4f3037adb1d90f7d3be2ebdc005f4abcb00819267249c99a30f19a7501aa57f6'
        '30b1d70346aa5be9eb37d4b4dcf8813b758a95e3eecddca99571aeac0ba3fa28f695f41abdb766053231533f0e4cffc80d1843e71825c7ee38af5d1236dc2a70'
        '1a61a89531636b65dade03cd7edca8747b3e1e880f9bbd4d5a53cffa452d70fe17e345cfed739ae92e99e336d4c1f2633c84a5c84a4ee6da518762bf1396b1db'
        'a644617d2b42ab357da546a5c9e3182fa9d2d8ae36ee77b24a04ed036e837212c9cbbd2f40d6e0c6f075a38aa58c7a8c01807ff820c9ee4f6556c661be81e0cb'
        'd3c66e22c3cc1b8de1c0b60cd32701080d599dc9853af41d9d9d493ffe3a8d9a2573455d80dd0de019dfe9992187cb23b9df90c18f0ca5962912566014c6779c')
validpgpkeys=('28806A878AE423A28372792ED75899B9A724937A') # Nextcloud Security <security@nextcloud.com>
sha512sums=('a1ae3400f0fb5997e54b0cee821c50d13e4ba0e27c9d11731c8b5233cba564666121a58aed848ccd2593a9783e27db1ed98ff559588a76a1acaeaf083ef4404a'
            'SKIP'
            '6f9f284d78d414a3bb7c159a812b105e31e8cd2393afee44465701e6f18169709f6d492d790e403e1e66f308c51b6b6496d29ddce29e4fac2c73a3c84a10c7fe'
            '76754f2facddaca388a9cfe302850e3265bfeee55c5942d830a1bfd9a3ce303eb6e585ec93e372c9aabfe50f75f06912a88426d80e1b7808c73a18ffde52643f'
            '8a0cd48b39566ab94b5bf5989c630c2c7e4abe89cad89e5f8e85d3355b5e059f4a1ff1b4600a3c974f3b0bed33fa14831182517fd4b9fb5983c52396d3ab3588'
            '1d06f339c43d57e5f5406c2698b815241fd9e39039a9e55f777face510c9a5ddae5ccd4e051393e8f16f391301a6aa03fff2462837a2d3441d969ea7195e7d84'
            '4f951e7cad06940d983035c3dc51531bbbcbc0c74296af63f2fab1705b413f340ff67300506377fade0ed7ddecee8552b3da028711751c120f1fad4b1c33e8d5'
            'a3ebcabcdb8c2d2653f44a248abd213bc4dbb317766b82c8f3e93b31e72ace350d7e8037bd4e22a632ab33f739e1941467b0e9d2cf7d0a7433227b4169030051')
b2sums=('7c583c150f6b315830191329310993582439e7aef57f306b93681d654b8fa7d4d5dafee082befd493aafd2bf6efd940d52ca0ca05b8e42b79a1599ff3e809550'
        'SKIP'
        'a7e1aa1d8cb2b0ff7832bb7d6d857987733253317c0f3727e744502aeaa3b2008351b47ecc24e348fe7b252cefaffe2418797523ee288dfd55e128917e8fbe2c'
        '0776acc402b4f6a913ab904bf9721fdb927f37410f599afb6b77411243e6d5db4f3037adb1d90f7d3be2ebdc005f4abcb00819267249c99a30f19a7501aa57f6'
        '30b1d70346aa5be9eb37d4b4dcf8813b758a95e3eecddca99571aeac0ba3fa28f695f41abdb766053231533f0e4cffc80d1843e71825c7ee38af5d1236dc2a70'
        '1a61a89531636b65dade03cd7edca8747b3e1e880f9bbd4d5a53cffa452d70fe17e345cfed739ae92e99e336d4c1f2633c84a5c84a4ee6da518762bf1396b1db'
        'a644617d2b42ab357da546a5c9e3182fa9d2d8ae36ee77b24a04ed036e837212c9cbbd2f40d6e0c6f075a38aa58c7a8c01807ff820c9ee4f6556c661be81e0cb'
        'd3c66e22c3cc1b8de1c0b60cd32701080d599dc9853af41d9d9d493ffe3a8d9a2573455d80dd0de019dfe9992187cb23b9df90c18f0ca5962912566014c6779c')

prepare() {
  mv -v "${pkgname}" "${pkgname}-${pkgver}"
  cd "${pkgname}-${pkgver}"
  # set shebang for executable
  sed -e 's/env php/env php7/' -i occ
}

package() {
  cd "${pkgname}-${pkgver}"
  # sysusers.d integration
  install -vDm 644 ../${pkgname}.sysusers \
    "${pkgdir}/usr/lib/sysusers.d/${pkgname}.conf"
  # tmpfiles.d integration
  install -vDm 644 ../${pkgname}.tmpfiles \
    "${pkgdir}/usr/lib/tmpfiles.d/${pkgname}.conf"
  # state dir for data and writable apps
  install -vdm 750 "${pkgdir}/var/lib/${pkgname}/"
  install -vdm 755 "${pkgdir}/var/lib/${pkgname}/"{apps,data}
  # log dir
  install -vdm 750 "${pkgdir}/var/log/${pkgname}/"
  # uwsgi integration
  install -vDm 644 "../${pkgname}.uwsgi" "${pkgdir}/etc/uwsgi/${pkgname}.ini"
  # config
  install -vDm 640 config/config.sample.php "${pkgdir}/etc/webapps/${pkgname}/config.php"
  # occ script
  install -vDm 755 "../${pkgname}.occ.sh" "${pkgdir}/usr/bin/occ"
  # optional pacman hook
  install -vDm 644 "../${pkgname}.hook" -t "${pkgdir}/usr/share/doc/${pkgname}/"

  # webapp
  find . -type f \( \
    -iname "*.php" \
    -or -iname "*.bcmap" \
    -or -iname "*.crl" \
    -or -iname "*.crt" \
    -or -iname "*.css" \
    -or -iname "*.dist" \
    -or -iname "*.docx" \
    -or -iname "*.handlebars" \
    -or -iname "*.gif" \
    -or -iname "*.ico" \
    -or -iname "*.ini" \
    -or -iname "*.jpg" \
    -or -iname "*.js" \
    -or -iname "*.json" \
    -or -iname "*.lock" \
    -or -iname "*.map" \
    -or -iname "*.md" \
    -or -iname "*.odp" \
    -or -iname "*.ods" \
    -or -iname "*.odt" \
    -or -iname "*.pdf" \
    -or -iname "*.png" \
    -or -iname "*.properties" \
    -or -iname "*.scss" \
    -or -iname "*.svg" \
    -or -iname "*.ttf" \
    -or -iname "*.txt" \
    -or -iname "*.whiteboard" \
    -or -iname "*.woff" \
    -or -iname "*.yml" \
    -or -iname "*.xml" \
    -or -iname "*.xsd" \
    -or -iname "*COPYING*" \
    -or -iname "*LICENSE*" \
    -or -iname "*CAN_INSTALL" \
    -or -iname "*.htaccess" \
    \) -exec install -vDm 644 {} "${pkgdir}/usr/share/webapps/${pkgname}/"{} \;

  # config symlink
  ln -sv "/etc/webapps/${pkgname}/config.php" "${pkgdir}/usr/share/webapps/${pkgname}/config/config.php"
  # occ
  install -vDm 755 occ -t "${pkgdir}/usr/share/webapps/${pkgname}"
  # apache example conf
  install -vDm 644 ../apache.example.conf -t "${pkgdir}/usr/share/doc/${pkgname}/"
}
