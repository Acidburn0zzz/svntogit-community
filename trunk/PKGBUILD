# Maintainer: Balló György <ballogyor+arch at gmail dot com>

pkgname=fragments
pkgver=1.2
pkgrel=1
pkgdesc="BitTorrent client for GNOME"
arch=(x86_64)
url="https://github.com/haecker-felix/Fragments"
license=(GPL3)
depends=(curl libevent libhandy libnatpmp miniupnpc)
makedepends=(cmake git meson vala)
_commit=2e9b61e6c25cdfbcbe23032fa0242e76fb1d5ffd  # tags/1.2
source=("git+https://github.com/haecker-felix/Fragments#commit=$_commit"
        "git+https://github.com/transmission/transmission"
        "git+https://github.com/transmission/dht"
        "git+https://github.com/transmission/libb64"
        "git+https://github.com/transmission/libevent"
        "git+https://github.com/transmission/libnatpmp"
        "git+https://github.com/transmission/libutp"
        "git+https://github.com/transmission/miniupnpc")
sha256sums=('SKIP'
            'SKIP'
            'SKIP'
            'SKIP'
            'SKIP'
            'SKIP'
            'SKIP'
            'SKIP')

pkgver() {
  cd Fragments
  git describe --tags | sed 's/-/+/g'
}

prepare() {
  cd Fragments
  git submodule init
  git config --local submodule.submodules/transmission.url "$srcdir/transmission"
  git submodule update

  cd submodules/transmission
  git submodule init
  git config --local submodule.third-party/dht.url "$srcdir/dht"
  git config --local submodule.third-party/libb64.url "$srcdir/libb64"
  git config --local submodule.third-party/libevent.url "$srcdir/libevent"
  git config --local submodule.third-party/libnatpmp.url "$srcdir/libnatpmp"
  git config --local submodule.third-party/libutp.url "$srcdir/libutp"
  git config --local submodule.third-party/miniupnpc.url "$srcdir/miniupnpc"
  git submodule update
}

build() {
  arch-meson Fragments build
  ninja -C build
}

check() {
  meson test -C build
}

package() {
  DESTDIR="$pkgdir" meson install -C build
}
