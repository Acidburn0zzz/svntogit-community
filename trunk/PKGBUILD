# Maintainer: Daniel Bermond <dbermond@archlinux.org>
# Maintainer: Bruno Pagani <archange@archlinux.org>

pkgname=intel-graphics-compiler
epoch=1
pkgver=1.0.9389
pkgrel=1
pkgdesc="Intel Graphics Compiler for OpenCL"
arch=(x86_64)
url="https://github.com/intel/intel-graphics-compiler"
license=(MIT)
depends=(llvm-libs intel-opencl-clang ncurses zlib)
makedepends=(git cmake clang lld llvm python libunwind)
options=(!emptydirs)
source=(${url}/archive/igc-${pkgver}.tar.gz
        ${pkgname}-fix-lld-prebuilt.patch::https://github.com/intel/intel-graphics-compiler/pull/210.patch
        ${pkgname}-fix-216.patch::https://github.com/intel/intel-graphics-compiler/commit/99edbf49d7c97febca9fd354415a9a93c92421d3.patch
        git+https://github.com/intel/vc-intrinsics.git#commit=2cd5a7b013d09d21ad206708943faf0b575e0ece
        git+https://github.com/KhronosGroup/SPIRV-Tools.git
        git+https://github.com/KhronosGroup/SPIRV-Headers.git)
sha256sums=('563a525375c25875aeb41a0fed1ebe9d1c3d67355576c73948c5305bcac93e36'
            'b2da1a00ac59ce7e98fd6cfb554f8974b1500bc1b9973387181414ffa4cffea5'
            'c7a96b5629384422ff2d848624ac60d5cc6dffd0289bce430df1ba813a45474c'
            'SKIP'
            'SKIP'
            'SKIP')

prepare() {
  cd ${pkgname}-igc-${pkgver}
  # https://github.com/intel/intel-graphics-compiler/issues/216
  patch -p1 < ../${pkgname}-fix-216.patch
  patch -p1 < ../${pkgname}-fix-lld-prebuilt.patch
}

build() {
  cmake -B build -S ${pkgname}-igc-${pkgver} \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -DCMAKE_INSTALL_LIBDIR=lib \
    -DIGC_OPTION__ARCHITECTURE_TARGET='Linux64' \
    -DIGC_OPTION__CLANG_MODE=Prebuilds \
    -DIGC_OPTION__LLD_MODE=Prebuilds \
    -DIGC_OPTION__LLVM_PREFERRED_VERSION='13.0.0' \
    -DIGC_OPTION__LLVM_MODE=Prebuilds \
    -DIGC_OPTION__LINK_KHRONOS_SPIRV_TRANSLATOR=ON \
    -DIGC_OPTION__USE_KHRONOS_SPIRV_TRANSLATOR_IN_VC=ON \
    -DIGC_OPTION__SPIRV_TRANSLATOR_MODE=Prebuilds \
    -DVC_INTRINSICS_SRC="${srcdir}/vc-intrinsics" \
    -DINSTALL_GENX_IR=ON \
    -Wno-dev
  make -C build
}

package() {
  make -C build DESTDIR="${pkgdir}" install
  install -D -m644 ${pkgname}-igc-${pkgver}/LICENSE.md -t "${pkgdir}"/usr/share/licenses/${pkgname}
  mv "${pkgdir}"/usr/lib/igc/NOTICES.txt "${pkgdir}"/usr/share/licenses/${pkgname}
}
