From e9efe88316733178b9330b21eee2c207f01132fd Mon Sep 17 00:00:00 2001
From: Jeroen Demeyer <jdemeyer@cage.ugent.be>
Date: Tue, 6 Mar 2018 12:43:46 +0100
Subject: [PATCH 2/2] Use late includes

---
 src/sage_setup/autogen/interpreters/generator.py | 26 ------------------------
 src/setup.py                                     |  1 +
 2 files changed, 1 insertion(+), 26 deletions(-)

diff --git a/src/sage_setup/autogen/interpreters/generator.py b/src/sage_setup/autogen/interpreters/generator.py
index feefd9ee2f3..d1db4557784 100644
--- a/src/sage_setup/autogen/interpreters/generator.py
+++ b/src/sage_setup/autogen/interpreters/generator.py
@@ -277,32 +277,6 @@ def write_interpreter(self, write):
             /* {{ warn }} */
             #include <Python.h>
 
-            /* Some interpreter files (for example interp_el.c) need access
-             * to functions defined in the Cython wrapper. This is done by
-             * including a file wrapper_X.h which is auto-generated by
-             * Cython. It contains declarations for functions declared in
-             * wrapper_X.pyx as cdef public. Including wrapper_X.h allows
-             * interp_X.c to call those functions.
-             *
-             * The file interp_X.c is in turn included by wrapper_X.c,
-             * which is the compilation of wrapper_X.pyx.
-             *
-             * Now, for some reason, Cython puts include guards in wrapper_X.h
-             * and it also defines those guards in the wrapper_X.c file.
-             * This way, including the wrapper_X.h file from the wrapper_X.c file
-             * (indirectly through interp_X.c) has no effect. But we really want
-             * that header file to be included, so we #undef those include guards.
-             * This way, the functions will be declared twice (once in wrapper_X.h
-             * and once in wrapper_X.c) but that is legal in C.
-             *
-             * See https://trac.sagemath.org/ticket/21459 for why this hack is
-             * needed. If Cython merges https://github.com/cython/cython/pull/1650
-             * this hack could be replaced by using a late include for
-             * cdef extern from "sage/ext/interpreters/interp_{{ s.name }}.c"
-             */
-            #undef __PYX_HAVE__sage__ext__interpreters__wrapper_{{ s.name }}
-            #undef __PYX_HAVE_API__sage__ext__interpreters__wrapper_{{ s.name }}
-
             {% print(s.c_header) %}
 
             {{ myself.func_header() }} {
diff --git a/src/setup.py b/src/setup.py
index 5abd6dc5939..b706310a1de 100755
--- a/src/setup.py
+++ b/src/setup.py
@@ -284,6 +284,7 @@ def finalize_options(self):
             cdivision=True,
             embedsignature=True,
             fast_getattr=True,
+            preliminary_late_includes_cy28=True,
             profile=self.profile,
         )
         self.compile_time_env = dict(
