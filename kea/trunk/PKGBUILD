# Maintainer: Baptiste Jonglez <baptiste--aur at jonglez dot org>
# Contributor: nfnty
pkgname='kea'
pkgver='1.2.0'
pkgrel='1'
pkgdesc='High-performance, extensible DHCP server engine from ISC, supporting both DHCPv4 and DHCPv6'
arch=('i686' 'x86_64')
url='http://kea.isc.org'
license=('custom:MPL2.0')
depends=('botan' 'boost-libs' 'log4cplus' 'libmariadbclient' 'postgresql-libs')
optdepends=('mariadb: Lease information database'
            'postgresql: Lease information database'
	    'python: To use kea-shell')
makedepends=('boost'
             'postgresql' # Needed for some headers
             'python' # kea-shell
	     'libxslt' 'docbook-xsl' 'elinks') # Doc
# Checks are disabled for now
#checkdepends=('gtest' 'postgresql' 'mariadb' 'python' 'procps-ng') # procps-ng needed for 'pgrep'
source=(https://ftp.isc.org/isc/kea/${pkgver}/kea-${pkgver}.tar.gz{,.asc}
        fix-scripts-include-path.patch
        LICENSE)
sha512sums=('d90571027edbce9eeb75d9ac889865dc24c2fd3ab17e44e23337ff623ca098ffd02560f01273da3c28f13734d95d5950110bc116bed527a295a9dc70addcc240'
            'SKIP'
            '81874fd3a12f55ea23593b7248c7653450c3a6e5ba8e79c7c5fb40ab685b0dc5d4e29e50f10000bd9018200731dba35f15e5d86c8005c94d14865d73e19983e5'
            '32a402845f82f89a8357208be666b58672d70cf30fc264f3093b89b4201bf73b57877a080ed123c9beb8e50cd5396092a6286c33e511b595efb1b43e196e3be1')
validpgpkeys=('BE0E9748B718253A28BB89FFF1B11BF05CF02E57') # Internet Systems Consortium, Inc. (Signing key, 2017-2018) <codesign@isc.org>

prepare() {
  cd "${srcdir}/${pkgname}-${pkgver}"
  # The include path is set incorrectly (it uses undefined $prefix instead of /usr).
  # Also, it fallbacks to the absolute path inside the chrooted build dir,
  # which will certainly not exist on the target system...
  patch -p1 < "${srcdir}"/fix-scripts-include-path.patch
}

build() {
  cd "${srcdir}/${pkgname}-${pkgver}"
  ./configure \
      --prefix='/usr' \
      --sbindir='/usr/bin' \
      --libexecdir='/usr/bin' \
      --sysconfdir='/etc' \
      --localstatedir='/var' \
      --with-dhcp-mysql \
      --with-dhcp-pgsql \
      --enable-shell \
      --enable-generate-docs
  make
}

check() {
  cd "${srcdir}/${pkgname}-${pkgver}"
  # Disable for now, some tests fail (for instance dhcp-ddns.sigterm_test)
  #make check
}

package() {
  cd "${srcdir}/${pkgname}-${pkgver}"
  make DESTDIR="${pkgdir}" install
  # Handle /var/run -> /run symlink
  rmdir "${pkgdir}"/var/run/kea
  rmdir "${pkgdir}"/var/run
  mkdir -p "${pkgdir}"/run/kea
  install -Dm644 "${srcdir}"/LICENSE "${pkgdir}"/usr/share/licenses/${pkgname}/LICENSE
}
