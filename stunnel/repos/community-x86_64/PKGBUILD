# Maintainer: Lukas Fleischer <lfleischer@archlinux.org>
# Contributor: Kaiting Chen <kaitocracy@gmail.com>
# Contributor: Daniel J Griffiths <ghost1227@archlinux.us>
# Contributor: Kevin Piche <kevin@archlinux.org>

pkgname=stunnel
pkgver=5.47
pkgrel=1
pkgdesc="A program that allows you to encrypt arbitrary TCP connections inside SSL"
arch=('x86_64')
url="https://www.stunnel.org/"
license=('GPL')
depends=('openssl' 'libnsl')
makedepends=('systemd')
source=("https://www.stunnel.org/downloads/archive/5.x/$pkgname-$pkgver.tar.gz"{,.asc}
        'Makefile.patch'
        'stunnel.sysusers.conf'
        'stunnel.tmpfiles.conf')
sha512sums=('5e2c076956b1f2fc3bcb79aa0625f3bd65a32cd9e4e3cf837e21d58309a4aacb0294b3ec39895b0c7b26304d1b8417a6c2b0d477eff5b8ea7ea5a2c37f5e07a0'
            'SKIP'
            '2129af2b2594473c48c565bdc714774b382c40ac1926d6ccbc07bbc29d006b89c9dbae71496b404ceeeeaaf22cf40055d557d8b37a6aea20a228699721b79db1'
            '8a7199b94cda5da8c0b99b25daf4bead1398a28975eb6813139744a8a962db3aa058bc4c9e7ee4121a52c62c2e2c2ed46d1739414927b210e0ac68da48a7ef5e'
            'f4a1fa8a03796fd445b5851df22bbaba40b9b5821809a654733b5482c89be9d03a36f893ad4f69f9ae9a10bfc03c84f281082ed716be3597e594fc75be850493')
validpgpkeys=('AC915EA30645D9D3D4DAE4FEB1048932DD3AAAA3') # Micha≈Ç Trojnara

build() {
  cd "$srcdir/$pkgname-$pkgver"

  # don't create a certificate...
  patch -p0 <"$srcdir/Makefile.patch"

  ./configure --prefix=/usr \
    --sysconfdir=/etc \
    --localstatedir=/var \
    --enable-ipv6 \
    --disable-libwrap

  make
}

package() {
  cd "$srcdir/$pkgname-$pkgver"

  make DESTDIR="$pkgdir" install

  install -Dm644 tools/stunnel.service "$pkgdir/usr/lib/systemd/system/stunnel.service"
  install -Dm644 "$srcdir/stunnel.sysusers.conf" "$pkgdir/usr/lib/sysusers.d/stunnel.conf"
  install -Dm644 "$srcdir/stunnel.tmpfiles.conf" "$pkgdir/usr/lib/tmpfiles.d/stunnel.conf"

  sed -e "s:/usr/var/lib/stunnel/:/var/run/stunnel:g" \
      -e "s:/usr/etc/stunnel/:/etc/stunnel/:g" \
      -e "s:no\(body\|group\):stunnel:g" \
      -i "$pkgdir/etc/stunnel/stunnel.conf-sample"
}
