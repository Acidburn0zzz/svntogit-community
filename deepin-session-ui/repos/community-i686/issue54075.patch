From 28e0c04d652b5f0a492b1716d7bde2065557dcbf Mon Sep 17 00:00:00 2001
From: kirigaya <kirigaya@mkacg.com>
Date: Tue, 9 May 2017 10:01:24 +0800
Subject: [PATCH] dde-lock: frequent calls to DBUS cause timeout

Change-Id: I05a840c24e6276f34007b85ba76eefde10dd50aa
---
 dde-lock/lockmanager.cpp | 6 ++++++
 dde-lock/lockmanager.h   | 1 +
 2 files changed, 7 insertions(+)

diff --git a/dde-lock/lockmanager.cpp b/dde-lock/lockmanager.cpp
index 7c4b23b..f8cecdb 100644
--- a/dde-lock/lockmanager.cpp
+++ b/dde-lock/lockmanager.cpp
@@ -217,6 +217,7 @@ void LockManager::chooseUserMode()
 
 void LockManager::onUnlockFinished(QDBusPendingCallWatcher *w)
 {
+    m_checkingPWD = false;
 
     QDBusPendingReply<bool> reply = *w;
 
@@ -344,6 +345,11 @@ void LockManager::mouseReleaseEvent(QMouseEvent *e)
 
 void LockManager::unlock()
 {
+    if (m_checkingPWD)
+        return;
+
+    m_checkingPWD = true;
+
     if (!m_requireShutdownWidget->isHidden()) {
         m_requireShutdownWidget->shutdownAction();
         return;
diff --git a/dde-lock/lockmanager.h b/dde-lock/lockmanager.h
index 69c90bd..be3cc07 100644
--- a/dde-lock/lockmanager.h
+++ b/dde-lock/lockmanager.h
@@ -108,6 +108,7 @@ public slots:
     QSize m_passwdEditSize;
 
     int m_authFailureCount = 0;
+    bool m_checkingPWD = false;
 };
 
 #endif // LOCKMANAGER_H
From 9d3b0ed23549f86b6879f5778c61902dbb4ddc99 Mon Sep 17 00:00:00 2001
From: kirigaya <kirigaya@mkacg.com>
Date: Thu, 11 May 2017 17:25:31 +0800
Subject: [PATCH] Lock: fix error lock

Change-Id: I8037aec76679bde1bb0063bbbefebc74f9dd6ef3
---
 dde-lock/lockmanager.cpp | 13 ++++++++-----
 1 file changed, 8 insertions(+), 5 deletions(-)

diff --git a/dde-lock/lockmanager.cpp b/dde-lock/lockmanager.cpp
index 5d47927..3fc19b7 100644
--- a/dde-lock/lockmanager.cpp
+++ b/dde-lock/lockmanager.cpp
@@ -352,11 +352,6 @@ void LockManager::mouseReleaseEvent(QMouseEvent *e)
 
 void LockManager::unlock()
 {
-    if (m_checkingPWD)
-        return;
-
-    m_checkingPWD = true;
-
     if (!m_requireShutdownWidget->isHidden()) {
         m_requireShutdownWidget->shutdownAction();
         return;
@@ -371,6 +366,14 @@ void LockManager::unlock()
 
     m_userWidget->showLoadingAni();
 
+    if (!m_passwordEdit->isVisible())
+        return;
+
+    if (m_checkingPWD)
+        return;
+
+    m_checkingPWD = true;
+
 //    qDebug() << "unlock" << m_userWidget->currentUser() << m_passwordEdit->getText();
     const QString &username = m_userWidget->currentUser();
     const QString &password = m_passwordEdit->getText();
