From d507a90a39558d35217109393aba314f531e924e Mon Sep 17 00:00:00 2001
From: Abhilash Raj <raj.abhilash1@gmail.com>
Date: Sun, 8 Mar 2020 23:07:44 -0700
Subject: [PATCH] Fix the TemplateLoader for the new API in
 importlib_resources.

---
 setup.py                                      | 2 +-
 src/mailman/utilities/i18n.py                 | 4 ++--
 src/mailman/utilities/tests/test_modules.py   | 6 +++---
 src/mailman/utilities/tests/test_templates.py | 4 ++--
 5 files changed, 10 insertions(+), 8 deletions(-)

diff --git a/setup.py b/setup.py
index 10c13c04c..22f04b709 100644
--- a/setup.py
+++ b/setup.py
@@ -115,7 +115,7 @@ case second 'm'.  Any other spelling is incorrect.""",
         'flufl.bounce',
         'flufl.i18n>=2.0',
         'flufl.lock>=3.1',
-        'importlib_resources',
+        'importlib_resources>=1.1.0',
         'gunicorn',
         'lazr.config',
         'python-dateutil>=2.0',
diff --git a/src/mailman/utilities/i18n.py b/src/mailman/utilities/i18n.py
index 17d6c23ba..77e042020 100644
--- a/src/mailman/utilities/i18n.py
+++ b/src/mailman/utilities/i18n.py
@@ -21,7 +21,7 @@ import os
 import sys
 
 from contextlib import ExitStack
-from importlib_resources import path
+from importlib_resources import files
 from itertools import product
 from mailman.config import config
 from mailman.core.constants import system_preferences
@@ -114,7 +114,7 @@ def search(resources, template_file, mlist=None, language=None):
         languages.append(language)
     languages.reverse()
     # The non-language qualified $template_dir paths in search order.
-    templates_dir = str(resources.enter_context(path('mailman', 'templates')))
+    templates_dir = str(resources.enter_context(files('mailman.templates')))
     paths = [templates_dir, os.path.join(config.TEMPLATE_DIR, 'site')]
     if mlist is not None:
         # Don't forget these are in REVERSE search order!
diff --git a/src/mailman/utilities/tests/test_modules.py b/src/mailman/utilities/tests/test_modules.py
index 669c07abe..f3c1bb6bb 100644
--- a/src/mailman/utilities/tests/test_modules.py
+++ b/src/mailman/utilities/tests/test_modules.py
@@ -22,7 +22,7 @@ import sys
 import unittest
 
 from contextlib import ExitStack, contextmanager
-from importlib_resources import path
+from importlib_resources import files
 from mailman.interfaces.rules import IRule
 from mailman.interfaces.styles import IStyle
 from mailman.testing.helpers import configuration
@@ -162,7 +162,7 @@ class AbstractStyle:
     def test_find_pluggable_components_by_plugin_name(self):
         with ExitStack() as resources:
             testing_path = resources.enter_context(
-                path('mailman.plugins.testing', ''))
+                files('mailman.plugins.testing'))
             resources.enter_context(hack_syspath(0, str(testing_path)))
             resources.enter_context(configuration('plugin.example', **{
                 'class': 'example.hooks.ExamplePlugin',
@@ -174,7 +174,7 @@ class AbstractStyle:
     def test_find_pluggable_components_by_component_package(self):
         with ExitStack() as resources:
             testing_path = resources.enter_context(
-                path('mailman.plugins.testing', ''))
+                files('mailman.plugins.testing'))
             resources.enter_context(hack_syspath(0, str(testing_path)))
             resources.enter_context(configuration('plugin.example', **{
                 'class': 'example.hooks.ExamplePlugin',
diff --git a/src/mailman/utilities/tests/test_templates.py b/src/mailman/utilities/tests/test_templates.py
index 32e8c5ad9..34ac5bcdf 100644
--- a/src/mailman/utilities/tests/test_templates.py
+++ b/src/mailman/utilities/tests/test_templates.py
@@ -23,7 +23,7 @@ import tempfile
 import unittest
 
 from contextlib import ExitStack
-from importlib_resources import path as resource_path
+from importlib_resources import files as resource_path
 from mailman.app.lifecycle import create_list
 from mailman.config import config
 from mailman.interfaces.languages import ILanguageManager
@@ -64,7 +64,7 @@ class TestSearchOrder(unittest.TestCase):
         # /m/ as the root.
         with ExitStack() as resources:
             in_tree = str(resources.enter_context(
-                resource_path('mailman', 'templates')).parent)
+                resource_path('mailman.templates')).parent)
             raw_search_order = search(
                 resources, template_file, mailing_list, language)
         for path in raw_search_order:
-- 
2.24.1

