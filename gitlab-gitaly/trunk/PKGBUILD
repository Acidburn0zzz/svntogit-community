# Maintainer: Sven-Hendrik Haase <sh@lutzhaase.com>

pkgname=gitlab-gitaly
pkgver=0.13.0
pkgrel=1
pkgdesc="Speed up Git access using caching"
arch=('i686' 'x86_64')
url="https://gitlab.com/gitlab-org/gitaly"
license=('MIT')
depends=('glibc' 'gitlab-shell')
makedepends=('go')
source=("${pkgname}-${pkgver}.tar.gz::https://gitlab.com/gitlab-org/gitaly/repository/archive.tar.gz?ref=v${pkgver}"
        "gitlab-gitaly.service")
sha512sums=('ed75be44cac04df10c810a07e0dce5b85a4bd5d20c0d855941c40903bcee6e08dd549ce9d58bdd67d60c5a0920785d4afa48fe9307ad8b4b87d22929aed4ddcb'
            '2821d1f9b0d0ac2f4b0e59c2b5813929f34eb769511a246637232b4c85ed37b6a023c206a1819794703bb880294bedd167fdbda0150719481c1048001e1c8b95')

_homedir="/var/lib/${pkgname}"

package() {
  cd "${pkgname}-v${pkgver}-"*

  make PREFIX=/usr DESTDIR=${pkgdir} install
  mkdir -p "${pkgdir}/etc/${pkgname}"
  sed -e "s|socket_path.*|socket_path = ${_homedir}/sockets/gitlab-gitaly.socket"
    config.toml.example "${pkgdir}/etc/${pkgname}/config.toml"

  install -Dm644 config.toml.example "${pkgdir}/usr/share/${pkgname}/config.toml.example"
  install -Dm644 "LICENSE" "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
  install -Dm0644 "${srcdir}/gitlab-gitaly.service" "${pkgdir}/usr/lib/systemd/system/gitlab-gitaly.service"
}

# vim:set ts=2 sw=2 et:
