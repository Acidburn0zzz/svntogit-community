# $Id$
# Maintainer: Sergej Pupykin <pupykin.s+arch@gmail.com>
# Contributor: Jens Adam (byte/jra) <j_adam@web.de>

pkgname=lazarus
pkgver=0.9.29
_snapshot=27914-20101028
pkgrel=2
pkgdesc='Delphi-like IDE for FreePascal'
url='http://www.lazarus.freepascal.org/'
license=('GPL2' 'MPL' 'custom:LGPL')
arch=('i686' 'x86_64')
depends=('fpc' 'fpc-src' 'gdk-pixbuf' 'gtk2')
#makedepends=(rpmextract)
options=('!emptydirs' '!makeflags')
source=(http://mirrors.iwi.me/lazarus/snapshots/lazarus-$pkgver-${_snapshot}-src.tar.bz2)
md5sums=('87de5c12c36de92f901e5051ecc75813')

build() {
#  [ $NOEXTRACT -eq 1  ] || rpmextract.sh lazarus-$pkgver.${_snapshot}.src.rpm
#  [ $NOEXTRACT -eq 1  ] || tar xzf lazarus-$pkgver.${_snapshot}.tar.gz

  cd $srcdir/${pkgname}
  # don't 'make examples' or you'll end up with a 100MB pkg
#  patch -p1 <debian/patches/01_topmakefile.diff
#  patch -p1 <debian/patches/02_components.diff
#  find -name Makefile.fpc -execdir sh -c 'rm $(basename {} .fpc)' \;
#  fpcmake ...
  make FPC=/usr/bin/fpc clean all
  (cd components && make bigidecomponents)

  # skip the 'make install' mess completely and do everything manually
  mkdir -p $pkgdir/usr/lib/lazarus $pkgdir/usr/bin $pkgdir/usr/share/man/man1 $pkgdir/usr/share/doc
  rm -r debian
  cp -R . $pkgdir/usr/lib/lazarus

  ln -s /usr/lib/lazarus/lazarus $pkgdir/usr/bin/lazarus
  ln -s /usr/lib/lazarus/startlazarus $pkgdir/usr/bin/startlazarus
  ln -s /usr/lib/lazarus/lazbuild $pkgdir/usr/bin/lazbuild

  cp -R install/man/man1/* $pkgdir/usr/share/man/man1/

  mv $pkgdir/usr/lib/lazarus/docs $pkgdir/usr/share/doc/lazarus

  # make 'desktop-file-validate' happy and fix missing .png icon
  sed -e 's|\(Categories\).*|\1=IDE;Development;|' \
      -e 's|\.png|\.xpm|' -i install/lazarus.desktop
  install -Dm644 install/lazarus.desktop $pkgdir/usr/share/applications/lazarus.desktop
  install -Dm644 images/ide_icon48x48.png $pkgdir/usr/share/pixmaps/lazarus.png
  rm -r $pkgdir/usr/lib/lazarus/install

  # license files: /usr/lib/lazarus/COPYING*
  install -D -m644 COPYING.modifiedLGPL.txt $pkgdir/usr/share/licenses/$pkgname/COPYING.modifiedLGPL

  # strip
  find $pkgdir -perm /ugo+x -type f -exec strip {} \;
  find $pkgdir -name \*.so -type f -exec strip {} \;
}
